<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>DawaTime Account Management</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://fonts.googleapis.com/css?family=Nunito:700,400&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Nunito", Arial, sans-serif;
        background: #f8f8f8;
        margin: 0;
        padding: 0;
        color: #222;
      }
      .container {
        max-width: 420px;
        margin: 48px auto;
        background: #fff;
        border-radius: 18px;
        box-shadow: 0 2px 16px rgba(0, 0, 0, 0.07);
        padding: 32px 24px 24px 24px;
        text-align: center;
      }
      .logo {
        width: 80px;
        height: 80px;
        margin-bottom: 18px;
      }
      h1 {
        color: #8ac249;
        font-size: 2rem;
        margin-bottom: 8px;
        font-weight: 700;
        text-align: center;
        letter-spacing: 1px;
      }
      p {
        font-size: 1rem;
        margin-bottom: 24px;
        text-align: center;
        color: #444;
      }
      label {
        font-weight: 700;
        display: block;
        margin-bottom: 8px;
        color: #333;
        text-align: left;
      }
      input {
        width: 100%;
        padding: 10px 12px;
        margin-bottom: 18px;
        border: 1px solid #d0d0d0;
        border-radius: 8px;
        font-size: 1rem;
        font-family: inherit;
        background: #fafafa;
      }
      button {
        background: #8ac249;
        color: #fff;
        font-weight: 700;
        border: none;
        border-radius: 8px;
        padding: 14px 0;
        width: 100%;
        font-size: 1.1rem;
        cursor: pointer;
        transition: background 0.2s;
        margin-bottom: 16px;
        box-shadow: 0 2px 8px rgba(138, 194, 73, 0.08);
      }
      button:disabled {
        background: #b5d89c;
        cursor: not-allowed;
      }
      .success,
      .error {
        text-align: center;
        margin-bottom: 16px;
        font-weight: 700;
      }
      .success {
        color: #388e3c;
      }
      .error {
        color: #d32f2f;
      }
      @media (max-width: 500px) {
        .container {
          padding: 18px 6px;
        }
        .logo {
          width: 60px;
          height: 60px;
        }
      }
    </style>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyAhDn-8YAZvCnVO-ARF6uuUJO6YkPBbmS8",
        authDomain: "medication-cd9b8.firebaseapp.com",
        projectId: "medication-cd9b8",
        appId: "1:173965270100:web:b09f542fe0573e4cc8e1c1",
      };
      firebase.initializeApp(firebaseConfig);
    </script>
  </head>
  <body>
    <div class="container">
      <img src="DawaTime.png" class="logo" alt="DawaTime Logo" />
      <h1 id="mainTitle">Account Management</h1>
      <div id="mainContent"></div>
      <p style="font-size: 0.95rem; color: #888; margin-top: 18px">
        Need help? Contact
        <a href="mailto:help@dawatime.com">help@dawatime.com</a>.
      </p>
    </div>
    <script>
      const params = new URLSearchParams(window.location.search);
      const mode = params.get("mode");
      const oobCode = params.get("oobCode");
      const mainTitle = document.getElementById("mainTitle");
      const mainContent = document.getElementById("mainContent");

      function showMessage(msg, type) {
        mainContent.innerHTML = `<div class="${type}">${msg}</div>`;
      }

      if (!mode || !oobCode) {
        showMessage("Invalid or missing action code.", "error");
      } else if (mode === "resetPassword") {
        mainTitle.textContent = "Reset Password";
        mainContent.innerHTML = `
        <p>Enter your new password below to reset your DawaTime account password.</p>
        <form id="resetForm">
          <label for="password">New Password</label>
          <input type="password" id="password" name="password" required minlength="6" placeholder="Enter new password" />
          <button type="submit">Reset Password</button>
          <div id="formMessage"></div>
        </form>
      `;
        document
          .getElementById("resetForm")
          .addEventListener("submit", async function (e) {
            e.preventDefault();
            const password = document.getElementById("password").value.trim();
            const msg = document.getElementById("formMessage");
            msg.textContent = "Processing...";
            msg.className = "";
            try {
              await firebase.auth().confirmPasswordReset(oobCode, password);
              msg.textContent = "Your password has been reset successfully.";
              msg.className = "success";
              document.getElementById("resetForm").reset();
              document.querySelector("#resetForm button").disabled = true;
            } catch (err) {
              msg.textContent =
                "Error: " + (err.message || "Unable to reset password.");
              msg.className = "error";
            }
          });
      } else if (mode === "verifyEmail") {
        mainTitle.textContent = "Verify Email";
        mainContent.innerHTML = `
        <p>Click the button below to verify your DawaTime email address.<br>If you did not request this, you can ignore this page.</p>
        <button id="verifyBtn">Verify Email</button>
        <div id="formMessage"></div>
      `;
        document
          .getElementById("verifyBtn")
          .addEventListener("click", async function () {
            const msg = document.getElementById("formMessage");
            this.disabled = true;
            msg.textContent = "Processing...";
            msg.className = "";
            try {
              await firebase.auth().applyActionCode(oobCode);
              msg.textContent =
                "Your email address has been verified successfully.";
              msg.className = "success";
            } catch (err) {
              msg.textContent =
                "Error: " + (err.message || "Unable to verify email.");
              msg.className = "error";
            }
          });
      } else if (mode === "recoverEmail") {
        mainTitle.textContent = "Confirm Email Change";
        mainContent.innerHTML = `
        <p>Click the button below to confirm your DawaTime email address change.<br>If you did not request this, you can ignore this page.</p>
        <button id="confirmBtn">Confirm Email Change</button>
        <div id="formMessage"></div>
      `;
        document
          .getElementById("confirmBtn")
          .addEventListener("click", async function () {
            const msg = document.getElementById("formMessage");
            this.disabled = true;
            msg.textContent = "Processing...";
            msg.className = "";
            try {
              await firebase.auth().checkActionCode(oobCode);
              await firebase.auth().applyActionCode(oobCode);
              msg.textContent =
                "Your email address has been changed successfully.";
              msg.className = "success";
            } catch (err) {
              msg.textContent =
                "Error: " + (err.message || "Unable to confirm email change.");
              msg.className = "error";
            }
          });
      } else if (mode === "verifyAndChangeEmail") {
        mainTitle.textContent = "Verify New Email";
        mainContent.innerHTML = `
        <p>Click the button below to verify your new DawaTime email address.<br>If you did not request this, you can ignore this page.</p>
        <button id="verifyChangeBtn">Verify New Email</button>
        <div id="formMessage"></div>
      `;
        document
          .getElementById("verifyChangeBtn")
          .addEventListener("click", async function () {
            const msg = document.getElementById("formMessage");
            this.disabled = true;
            msg.textContent = "Processing...";
            msg.className = "";
            try {
              await firebase.auth().applyActionCode(oobCode);
              msg.textContent =
                "Your new email address has been verified and updated successfully.";
              msg.className = "success";
            } catch (err) {
              msg.textContent =
                "Error: " +
                (err.message || "Unable to verify new email address.");
              msg.className = "error";
            }
          });
      } else {
        showMessage("Unknown action mode.", "error");
      }
    </script>
  </body>
</html>
